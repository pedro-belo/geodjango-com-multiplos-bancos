<!doctype html>
<html lang="pt-br">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin="" />
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>
    <style>
        #mapa {
            height: 90vh;
        }
    </style>
    <title>Hello, world!</title>
</head>

<body>

    <div class="container">

        <div class="row">

            <div class="col-12 col-md-10 offset-md-1 p-0">
                <form>
                    {{form.product}}
                </form>
            </div>
            <div class="col-1 my-1">
                <a href="#" class="btn btn-lg btn-outline-primary btn-block">Vender</a>
            </div>
            <div class="col-12 col-md-10 offset-md-1 p-0">
                <div id="mapa"></div>
            </div>

        </div>

    </div>

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
        crossorigin="anonymous"></script>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    
    <script>
        const mapa = L.map('mapa').setView([-6.035542664805823, -37.01763599023379], 8);
        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoicGVkcm8tYmVsbyIsImEiOiJja244ZXlwZW0weGFtMnhzOXU5Z24wbWxiIn0.Z8iDggzi6rRVEITlLX__FQ', {
            maxZoom: 18,
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1,
            accessToken: 'pk.eyJ1IjoicGVkcm8tYmVsbyIsImEiOiJja244ZXlwZW0weGFtMnhzOXU5Z24wbWxiIn0.Z8iDggzi6rRVEITlLX__FQ'
        }).addTo(mapa);

        function calcular_opacity(produto, oferta){

            const somatorio = produto.ofertas.map(function(oferta){
                return oferta.ofertas;
            }).reduce(function(acumulador, atual){
                return acumulador + atual;
            });

            return oferta.ofertas / somatorio;
        }

        function reset_map(){
            mapa.eachLayer(function(layer){
                                if(layer.options.is_offer_layer){
                                    mapa.removeLayer(layer);
                                }
                            });
        }

        $(document).ready(function() {
            $("#{{form.product.id_for_label}}").change(function() {
                
                if($("#{{form.product.id_for_label}}").val()){
                    $.ajax({
                    url: `produto/${$("#{{form.product.id_for_label}}").val()}`,
                    contentType: "application/json",
                    method: "GET"
                    }).done(function(produto) {
                        
                        reset_map();
                        produto.ofertas.forEach(oferta => {
                            L.circle(
                                [oferta.coords[0], oferta.coords[1]], {
                                    color: '#f03',
                                    fillColor: '#f03',
                                    is_offer_layer: true,
                                    fillOpacity: calcular_opacity(produto, oferta),
                                    radius: 3000
                                })
                                    .addTo(mapa)
                                    .bindTooltip(`${oferta.ofertas} ${oferta.ofertas > 1 ? 'ofertas' : 'oferta'} em ${oferta.nome}`);
                        });
                    });
                }else{
                    console.log('empty')
                }

            });
        });

        // L.circle([{{agricultor.municipio.geom.point_on_surface.coords.1}}, {{agricultor.municipio.geom.point_on_surface.coords.0}}], {
        //     color: 'red',
		// fillColor: '#f03',
		// fillOpacity: 0.5,
		// radius: 500
        // }).addTo(mymap).bindPopup("{{agricultor.municipio}} - ").openPopup();;
    </script>
</body>

</html>